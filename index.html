<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marathon Pace Tracker</title>
    <style>
$1
        .runner-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        .brandon { background-color: #007bff; }
        .claire { background-color: #e83e8c; }
        .derek { background-color: #ffc107; }
        .mitch { background-color: #6f42c1; }
</style>
</head>
<body onload='initializeLapTime()'>
<div class="container">
        <label for="runnerSelect">Select Runner:</label>
        <select id="runnerSelect" onchange="changeRunner()">
            <option value="Brandon">Brandon</option>
            <option value="Claire">Claire</option>
            <option value="Derek">Derek</option>
            <option value="Mitch" selected>Mitch</option>
            <option value="All">All</option>
        </select>
        <h2>Marathon Pace Tracker</h2>
        <button id="milesBtn" onclick="setPaceUnit('miles')" class="active">Miles</button>
        <button id="kmBtn" onclick="setPaceUnit('km')">Kilometers</button>
        <p>Enter the time you see the runner at each checkpoint:</p>
        <input type="time" step="1" id="lapTime" value="" onkeypress="if(event.key==='Enter'){ addLapTime(); }">
        <button onclick="addLapTime()">Add Lap Time</button>
        <p>Enter checkpoint distance (miles):</p>
        <input type="number" id="checkpointDistance" value="1.0" step="0.01" max="2.96">
        <button onclick="updateCheckpointDistance()">Set Distance</button>
        <table>
            <thead>
                <tr>
                    <th>Lap</th>
                    <th style="width: 75px;">Elapsed Distance (<span id='distanceUnit'>Miles</span>)</th>
                    <th>Time</th>
                    <th>Lap Time</th>
                    <th>Total Time</th>
                    <th style="width: 150px; white-space: pre-line;">Lap Pace</th>
                    <th style="width: 150px; white-space: pre-line;">Total Avg Pace</th>
                    <th>Projected Finish</th>
                    <th>+/- Sub-3:00 Pace</th>
                </tr>
            </thead>
            <tbody id="lapTableBody"></tbody>
        </table>
</div>
<script>
let runners = {
    Brandon: [],
    Claire: [],
    Derek: [],
    Mitch: []
};
let currentRunner = 'Mitch';
let checkpointDistance = 1.0;
const totalDistance = 26.2;
const sub3TotalSeconds = 10799;
const sub3PacePerMile = sub3TotalSeconds / totalDistance;

function updateCheckpointDistance() {
    const input = document.getElementById('checkpointDistance').value;
    checkpointDistance = Math.min(parseFloat(input) || 1.0, 2.96);
    updateTable();
}

function initializeLapTime() {
    const now = new Date();
    document.getElementById('lapTime').value = now.toTimeString().slice(0, 5);
}

function addLapTime() {
    if (currentRunner === 'All') {
        alert("Please select a specific runner to add lap times.");
        return;
    }
    const input = document.getElementById('lapTime');
    const timeValue = input.value;
    if (!timeValue) return;

    const now = new Date();
    const lapTime = new Date(`${now.toDateString()} ${timeValue}`);
    if (runners[currentRunner].length > 0 && lapTime <= runners[currentRunner][runners[currentRunner].length - 1]) {
        alert("Each lap time must be later than the previous one.");
        return;
    }
    runners[currentRunner].push(lapTime);
    updateTable();
    const updatedNow = new Date();
    input.value = updatedNow.toTimeString().slice(0, 5);
}

function formatTime(seconds, forceHHMMSS = true) {
    let h = Math.floor(seconds / 3600);
    let m = Math.floor((seconds % 3600) / 60);
    let s = Math.floor(seconds % 60);
    return forceHHMMSS || h > 0
        ? `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`
        : `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

let paceUnit = 'miles';
function setPaceUnit(unit) {
    paceUnit = unit;
    document.getElementById('distanceUnit').innerText = paceUnit === 'miles' ? 'Miles' : 'Kilometers';
    document.getElementById('milesBtn').classList.remove('active');
    document.getElementById('kmBtn').classList.remove('active');
    document.getElementById(unit + 'Btn').classList.add('active');
    updateTable();
}

function changeRunner() {
    currentRunner = document.getElementById('runnerSelect').value;
    updateTable();
}

function updateTable() {
    let lapTimesToDisplay = currentRunner === 'All'
        ? Object.entries(runners).flatMap(([name, laps]) =>
            laps.map((time, index) => ({ name, time, index }))).sort((a, b) => a.time - b.time)
        : runners[currentRunner].map((time, index) => ({ name: currentRunner, time, index }));

    const tableBody = document.getElementById('lapTableBody');
    tableBody.innerHTML = "";
    if (lapTimesToDisplay.length === 0) return;

    let totalElapsed = 0;
    let totalDistanceCovered = 0;

    lapTimesToDisplay.forEach(({ name, time, index }, displayIndex) => {
        let lapElapsed = index === 0 ? checkpointDistance * sub3PacePerMile
                                     : (runners[name][index] - runners[name][index - 1]) / 1000;
        if (lapElapsed < 0 || isNaN(lapElapsed)) lapElapsed = 0;
        totalElapsed += lapElapsed;
        totalDistanceCovered = checkpointDistance + (index * 2.96);
        let displayDistance = paceUnit === 'miles' ? totalDistanceCovered : totalDistanceCovered * 1.609;

        let lapPacePerMile = lapElapsed / (index === 0 ? checkpointDistance : 2.96);
        let lapPacePerKm = lapPacePerMile / 1.609;
        let lapPaceConverted = paceUnit === 'miles' ? lapPacePerMile : lapPacePerKm;
        let lapPaceText = `${formatTime(lapPaceConverted, false)} ${paceUnit === 'miles' ? '/mi' : '/km'}`;

        let avgPacePerMile = totalElapsed / totalDistanceCovered;
        let avgPacePerKm = avgPacePerMile / 1.609;
        let avgPaceConverted = paceUnit === 'miles' ? avgPacePerMile : avgPacePerKm;
        let avgPaceText = `${formatTime(avgPaceConverted, false)} ${paceUnit === 'miles' ? '/mi' : '/km'}`;

        let distanceRemaining = totalDistance - totalDistanceCovered;
        if (paceUnit === 'km') distanceRemaining *= 1.609;

        let projectedFinishElapsed = totalDistanceCovered > 0
            ? totalElapsed + (distanceRemaining * avgPaceConverted)
            : totalElapsed;

        let comparison = projectedFinishElapsed - sub3TotalSeconds;
        let comparisonText = comparison > 0
            ? `+${formatTime(comparison, false)}`
            : `-${formatTime(Math.abs(comparison), false)}`;

        const row = `<tr>
            <td>${index + 1} (${name})<span class='runner-badge ${name.toLowerCase()}'></span></td>
            <td>${displayDistance.toFixed(2)} ${paceUnit === 'miles' ? 'mi' : 'km'}</td>
            <td>
                <span id="timeDisplay_${name}_${index}">${time.toLocaleTimeString()}</span>
                <input type="time" id="timeInput_${name}_${index}" style="display:none"
                       value="${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}:${time.getSeconds().toString().padStart(2, '0')}">
                <button onclick="enableEdit('${name}', ${index})">Edit</button>
                <button onclick="saveEdit('${name}', ${index})" style="display:none" id="saveBtn_${name}_${index}">Save</button>
            </td>
            <td>${formatTime(lapElapsed)}</td>
            <td>${formatTime(totalElapsed)}</td>
            <td>${lapPaceText}</td>
            <td>${avgPaceText}</td>
            <td>${formatTime(projectedFinishElapsed)}</td>
            <td>${comparisonText}</td>
            <td><button onclick="deleteLap('${name}', ${index})">Delete</button></td>
        </tr>`;
        tableBody.innerHTML += row;
    });
}

function enableEdit(name, index) {
    document.getElementById(`timeDisplay_${name}_${index}`).style.display = 'none';
    document.getElementById(`timeInput_${name}_${index}`).style.display = 'inline';
    document.getElementById(`saveBtn_${name}_${index}`).style.display = 'inline';
}

function saveEdit(name, index) {
    const input = document.getElementById(`timeInput_${name}_${index}`);
    const newTimeStr = input.value;
    if (!newTimeStr) return;
    const now = new Date();
    const newTime = new Date(`${now.toDateString()} ${newTimeStr}`);
    if (index > 0 && newTime <= runners[name][index - 1]) {
        alert("New time must be after the previous lap time.");
        return;
    }
    if (index < runners[name].length - 1 && newTime >= runners[name][index + 1]) {
        alert("New time must be before the next lap time.");
        return;
    }
    runners[name][index] = newTime;
    updateTable();
}

function deleteLap(name, index) {
    runners[name].splice(index, 1);
    updateTable();
}
</script>
</body>
</html>
